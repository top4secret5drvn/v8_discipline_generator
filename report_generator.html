<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css">
  <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ—Ç—á—ë—Ç–∞ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã ‚Äî –î–ï–ù–¨ (—Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö)</title>

</head>
<body>
  <h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ—Ç—á—ë—Ç–∞ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã (—Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö)</h1>
  <p class="small">–ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç: <br>+/- –ù–∞–∑–≤–∞–Ω–∏–µ_–ø—Ä–∏–≤—ã—á–∫–∏ ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü–∞ I[0.00] S[0.01] W[0.01] E[0.00] C[0.01] H[0.01] ST[1] $[0]<br>* –°–æ—Å—Ç–∞–≤–Ω–∞—è_–ø—Ä–∏–≤—ã—á–∫–∞: (–ø–æ–¥–∑–∞–¥–∞—á–∏ —Å + –∏–ª–∏ -)</p>

  <label for="lastDay">–ü–æ—Å–ª–µ–¥–Ω–∏–π –∏–∑–≤–µ—Å—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –¥–Ω—è (—Ü–µ–ª–æ–µ)</label>
  <input id="lastDay" type="number" value="175" />

  <label for="lastDate">–ü–æ—Å–ª–µ–¥–Ω—è—è –∏–∑–≤–µ—Å—Ç–Ω–∞—è –¥–∞—Ç–∞</label>
  <input id="lastDate" type="date" value="2025-08-31" />

  <label for="tasksInput">–°–ø–∏—Å–æ–∫ –ø—Ä–∏–≤—ã—á–µ–∫/–∑–∞–¥–∞—á (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç)</label>
  <textarea id="tasksInput" placeholder="–ü—Ä–∏–º–µ—Ä:
–ó–¥–æ—Ä–æ–≤—å–µ
‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
* –§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞:
    + –ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è ‚Äî 75 —Ä–∞–∑ I[0.00] S[0.01] W[0.01] E[0.00] C[0.01] H[0.01] ST[1] $[0]
    + –û—Ç–∂–∏–º–∞–Ω–∏—è ‚Äî 30 —Ä–∞–∑ I[0.00] S[0.01] W[0.01] E[0.00] C[0.01] H[0.01] ST[1] $[0]
+ –ü–∏—Ç—å –≤–æ–¥—É ‚Äî 2 –ª–∏—Ç—Ä–∞ I[0.00] S[0.00] W[0.01] E[0.00] C[0.01] H[0.02] ST[1] $[0]"></textarea>

  <div class="controls">
    <button id="parseBtn" class="primary">–†–∞–∑–æ–±—Ä–∞—Ç—å –∏ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å</button>
    <button id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage</button>
    <button id="loadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ localStorage</button>
    <button id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    <button id="sampleBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–º–µ—Ä</button>
    <button id="loadFromDBBtn" class="primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –ë–î</button>
    <button id="saveToDBBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î</button>
    <button id="manageCombosBtn">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è–º–∏</button>
  </div>

  <div class="meta" id="metaBox">
    <div>–°–µ–≥–æ–¥–Ω—è (—Å–∏—Å—Ç–µ–º–Ω–æ–µ): <strong id="todayDisplay"></strong></div>
    <div>–¢–µ–∫—É—â–∏–π –Ω–æ–º–µ—Ä –¥–Ω—è –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã: <strong id="currentDayDisplay"></strong></div>
    <div class="small">–†–∞–∑–Ω–∏—Ü–∞ –¥–Ω–µ–π –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –¥–∞—Ç—ã: <span id="diffDays"></span></div>
    <div class="small">–í—ã–ø–æ–ª–Ω–µ–Ω–æ: <span id="completedCount">0</span> / <span id="totalCount">0</span> ‚Äî <strong id="percentDone">0%</strong></div>
    
    <div class="db-controls">
      <div style="flex:1">
        <div class="small">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:</div>
        <select id="dbDateSelect" style="width:100%; margin-top:4px;" onchange="loadDayFromDB()">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏–∑ –ë–î</option>
        </select>
      </div>
      <button id="addFromCatalogBtn" style="margin-top:18px">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É</button>
    </div>
    
    <div class="small" style="margin-top:8px;">–°—É–º–º–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ (—Ç–æ–ª—å–∫–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ):</div>
    <div id="totalStats" class="stats-grid">
      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
    
    <div class="small" style="margin-top:12px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥:</div>
    <div id="periodStats" class="controls" style="margin-top:4px;">
      <button onclick="loadPeriodStats('week')" class="small">–ù–µ–¥–µ–ª—è</button>
      <button onclick="loadPeriodStats('month')" class="small">–ú–µ—Å—è—Ü</button>
      <button onclick="loadPeriodStats('all')" class="small">–í—Å–µ –≤—Ä–µ–º—è</button>
    </div>
    <div id="periodStatsDisplay" class="small" style="margin-top:4px; color:#666;"></div>
  </div>

  <label for="stateSelect">–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–Ω—è</label>
  <label>–≠–º–æ—Ü–∏–∏ –¥–Ω—è</label>
  <div class="meta">
    <div class="small">–° –∫–∞–∫–æ–π —ç–º–æ—Ü–∏–µ–π –≤—Å—Ç–∞–ª</div>
    <div id="emotionMorning" class="inline"></div>
  </div>

  <div class="inline">
    <select id="stateSelect">
      <option value="WORK">WORK ‚Äî —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å: –æ–±—ã—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</option>
      <option value="VAC">VAC ‚Äî –≤—ã—Ö–æ–¥–Ω–æ–π/–æ—Ç–¥—ã—Ö: –ø–ª–∞–Ω –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö —Ä–∏—Ç—É–∞–ª–æ–≤</option>
      <option value="SICK">SICK ‚Äî –±–æ–ª–µ–∑–Ω—å/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî –æ—Ç–¥—ã—Ö</option>
      <option value="OTHER">OTHER ‚Äî –¥—Ä—É–≥–æ–µ (–∑–∞–º–µ—Ç–∫–∏)</option>
    </select>
  </div>
  <div id="stateDesc" class="state-desc">–û–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å.</div>

  <label for="thoughtsInput">–ú—ã—Å–ª–∏ –¥–Ω—è / –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
  <textarea id="thoughtsInput" placeholder="–ö–æ—Ä–æ—Ç–∫–æ: —á—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, —á—Ç–æ –≤–∞–∂–Ω–æ –∑–∞–ø–æ–º–Ω–∏—Ç—å, –∑–∞—Ç—Ä–∞—Ç—ã/—Å–∏–ª—ã, –ø–ª–∞–Ω –∑–∞–≤—Ç—Ä–∞..."></textarea>

  <div id="tasksList"></div>

  <label>–ö–æ–Ω—Ç—Ä–æ–ª—å –¥–Ω—è</label>
  <div class="meta">
    <div class="small">–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</div>
    <div id="questionsBox"></div>
  </div>

  <div class="footer-actions">
    <button id="makeReport">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç (—Ç–µ–∫—Å—Ç)</button>
    <button id="downloadPlainTXT">–°–∫–∞—á–∞—Ç—å TXT –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏</button>
    <button id="downloadCSV">–°–∫–∞—á–∞—Ç—å CSV</button>
    <button id="copyReport">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä</button>
    <button id="downloadReport">–°–∫–∞—á–∞—Ç—å .txt</button>
    <button id="resetStatuses">–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã</button>
  </div>

  <div id="reportOutput" class="reportOut" contenteditable="false" aria-live="polite"></div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –ø—Ä–∏–≤—ã—á–µ–∫ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ -->
  <div id="habitCatalogModal" class="modal">
    <div class="modal-content">
      <h3 style="margin-top:0">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–≤—ã—á–∫—É –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞</h3>
      <input type="text" id="habitSearch" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–∏–≤—ã—á–µ–∫..." style="width:100%; margin-bottom:12px;" onkeyup="filterHabits()">
      <div id="habitCatalogList">
        <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≤—ã—á–µ–∫ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∑–¥–µ—Å—å -->
      </div>
      <div style="margin-top:12px; text-align:right;">
        <button onclick="hideModal('habitCatalogModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–≤—ã—á–∫–∏ -->
	<div id="habitEditModal" class="modal">
	  <div class="modal-content">
		<h3 style="margin-top:0">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≤—ã—á–∫—É</h3>
		<input type="hidden" id="editIndex" />
		<label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
		<input id="editName" type="text" />
		<label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
		<input id="editCategory" type="text" />
		<label>–ö–æ–ª-–≤–æ</label>
		<input id="editQuantity" type="text" />
		<label>–ï–¥–∏–Ω–∏—Ü–∞</label>
		<input id="editUnit" type="text" />
		<label>–£—Å–ø–µ—Ö</label>
		<select id="editSuccess"><option value="1">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option><option value="0">–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</option></select>
		<div style="margin-top:12px; text-align:right;">
		  <button onclick="hideModal('habitEditModal')">–û—Ç–º–µ–Ω–∞</button>
		  <button id="saveEditBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
		</div>
	  </div>
	</div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Å–æ—á–µ—Ç–∞–Ω–∏–π -->
  <div id="comboModal" class="modal">
    <div class="modal-content">
      <h3>–°–æ—á–µ—Ç–∞–Ω–∏—è –ø—Ä–∏–≤—ã—á–µ–∫</h3>
      <div id="comboList"></div>
      <hr />
      <h4>–°–æ–∑–¥–∞—Ç—å —Å–æ—á–µ—Ç–∞–Ω–∏–µ</h4>
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
      <input id="comboName" type="text" />
      <label>–ü—Ä–∏–≤—ã—á–∫–∞ A</label>
      <select id="comboA"></select>
      <label>–ü—Ä–∏–≤—ã—á–∫–∞ B</label>
      <select id="comboB"></select>
      <label>–ë–æ–Ω—É—Å—ã (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å 0)</label>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px">
        <input id="comboI" placeholder="I" />
        <input id="comboS" placeholder="S" />
        <input id="comboW" placeholder="W" />
        <input id="comboE" placeholder="E" />
        <input id="comboC" placeholder="C" />
        <input id="comboH" placeholder="H" />
        <input id="comboST" placeholder="ST" />
        <input id="comboMoney" placeholder="$" />
      </div>
      <div style="margin-top:10px;text-align:right">
        <button onclick="hideModal('comboModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button onclick="createCombo()">–°–æ–∑–¥–∞—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    // –°–Ω–∞—á–∞–ª–∞ –æ–±—ä—è–≤–ª—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let todayDisplay, currentDayDisplay, diffDaysEl, lastDayEl, lastDateEl, tasksInput, parseBtn, tasksList;
    let makeReportBtn, reportOutput, copyReport, downloadReport, saveBtn, loadBtn, clearBtn, resetStatusesBtn, sampleBtn;
    let completedCountEl, totalCountEl, percentDoneEl, stateSelect, stateDesc, thoughtsInput;
    let habitsCatalog = [];
    let combosCatalog = [];
    let appliedCombos = []; // —Å–ø–∏—Å–æ–∫ —Å–æ—á–µ—Ç–∞–Ω–∏–π, –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ parsed
    let currentDayFromDB = null;
    let streaksData = {};
    let parsed = [];
	let dailyComparison = null;
	let allTimeTotals = null;
    let emotionMorning = null;
    let dailyQuestions = [];
    
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    const STATE_DESCRIPTIONS = {
      WORK: 'WORK ‚Äî —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å. –§–æ–∫—É—Å: –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–∏—Ç–º.',
      VAC: 'VAC ‚Äî –≤—ã—Ö–æ–¥–Ω–æ–π/–æ—Ç–¥—ã—Ö. –§–æ–∫—É—Å: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ä–∏—Ç—É–∞–ª—ã.',
      SICK: 'SICK ‚Äî –±–æ–ª–µ–∑–Ω—å/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ. –§–æ–∫—É—Å: –æ—Ç–¥—ã—Ö –∏ –ª–µ—á–µ–Ω–∏–µ, –Ω–∏–∑–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.',
      OTHER: 'OTHER ‚Äî –¥—Ä—É–≥–æ–µ. –ò—Å–ø–æ–ª—å–∑—É–π –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤.'
    };

    const EMOTIONS = [
      '–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ','–§–æ–∫—É—Å','–¢—Ä–µ–≤–æ–≥–∞','–£—Å—Ç–∞–ª–æ—Å—Ç—å',
      '–ó–ª–æ—Å—Ç—å','–†–∞–¥–æ—Å—Ç—å','–ü—É—Å—Ç–æ—Ç–∞','–í–æ–æ–¥—É—à–µ–≤–ª–µ–Ω–∏–µ'
    ];

    const CONTROL_QUESTIONS = [
      '–Ø –¥–µ–π—Å—Ç–≤–æ–≤–∞–ª —Å–µ–≥–æ–¥–Ω—è —á–µ—Å—Ç–Ω–æ –ø–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—é –∫ —Å–µ–±–µ?',
      '–Ø —Å–¥–µ–ª–∞–ª –º–∞–∫—Å–∏–º—É–º –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –≤ —Ç–µ–∫—É—â–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö?',
      '–Ø –Ω–µ –ø—Ä–µ–¥–∞–ª —Å–≤–æ–∏ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ —Å–µ–≥–æ–¥–Ω—è?',
      '–Ø —É–ø—Ä–∞–≤–ª—è–ª –≤–Ω–∏–º–∞–Ω–∏–µ–º, –∞ –Ω–µ –ø–ª—ã–ª –ø–æ –∏–Ω–µ—Ä—Ü–∏–∏?',
      '–Ø –∑–∞–≤–µ—Ä—à–∞–ª –∑–∞–¥–∞—á–∏, –∞ –Ω–µ –∏–º–∏—Ç–∏—Ä–æ–≤–∞–ª –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å?',
      '–≠—Ç–æ—Ç –¥–µ–Ω—å —É–∫—Ä–µ–ø–∏–ª –º–æ—é —Å–∏—Å—Ç–µ–º—É –∂–∏–∑–Ω–∏?'
    ];

    const STORAGE_KEY = 'discipline_report_v2';
    
    // –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function toISODate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }    

	function formatTotalsForReport(totals) {
	  if (!totals) return '‚Äî';
	  const order = [
		{ key: 'I', label: '–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç' },
		{ key: 'S', label: '–°–∏–ª–∞' },
		{ key: 'W', label: '–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å' },
		{ key: 'E', label: '–≠–º–æ—Ü–∏–∏' },
		{ key: 'C', label: '–•–∞—Ä–∏–∑–º–∞' },
		{ key: 'H', label: '–ó–¥–æ—Ä–æ–≤—å–µ' },
		{ key: 'ST', label: '–°—Ç–∞–±–∏–ª–æ' },
		{ key: '$', label: '–†—É–±–ª–µ–π' }
	  ];
	  const parts = [];
    let sumoftotals = 0;
	  order.forEach(o => {
		const v = totals[o.key];
		if (v !== undefined && Number(v) !== 0) {
		  // ST ‚Äî —Ü–µ–ª–æ–µ, $ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º/—Ü–µ–ª—ã–º; –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî —Ñ–æ—Ä–º–∞—Ç 2 –∑–Ω–∞–∫–∞
		  if (o.key === 'ST' || o.key === '$') parts.push(`${o.label}:${v}`);
		  else {
        parts.push(`${o.label} +%${Number(v).toFixed(2)}`);
        sumoftotals += Number(v);
      }
      
    }
	  });
    if (sumoftotals > 0) parts.push(`\n\n–Ø —Å—Ç–∞–ª –ª—É—á—à–µ –Ω–∞ +%${Number(sumoftotals).toFixed(2)}`);
	  return parts.length ? parts.join('  ') : '‚Äî';
	}

 
    function daysBetween(dateA, dateB){
      const a = new Date(dateA.getFullYear(), dateA.getMonth(), dateA.getDate());
      const b = new Date(dateB.getFullYear(), dateB.getMonth(), dateB.getDate());
      return Math.round((b - a) / 86400000);
    }
    
    function parseCharacteristics(text) {
      const stats = {
        I: 0, S: 0, W: 0, E: 0, C: 0, H: 0, ST: 0, $: 0
      };
      
      const regex = /([ISWEHC]|ST|\$)\[([-\d.]+)\]/g;
      let match;
      while ((match = regex.exec(text)) !== null) {
        const key = match[1];
        const value = parseFloat(match[2]);
        if (!isNaN(value)) {
          stats[key] = value;
        }
      }
      
      return stats;
    }
    
    function formatStats(stats) {
      return `I[${stats.I.toFixed(2)}] S[${stats.S.toFixed(2)}] W[${stats.W.toFixed(2)}] E[${stats.E.toFixed(2)}] C[${stats.C.toFixed(2)}] H[${stats.H.toFixed(2)}] ST[${stats.ST}] $[${stats.$}]`;
    }
    
    function calculateTotalStats(parsed) {
      const totals = {
        I: 0, S: 0, W: 0, E: 0, C: 0, H: 0, ST: 0, $: 0
      };
      
      function addStats(stats, success) {
        if (!success) return;
        for (const key in totals) {
          totals[key] += stats[key] || 0;
        }
      }
      
      parsed.forEach(item => {
        if (item.type === 'habit') {
          addStats(item.stats, item.success);
        } else if (item.type === 'composite_habit') {
          item.subtasks.forEach(subtask => {
            addStats(subtask.stats, subtask.success);
          });
        }
      });

      // –ø—Ä–∏–º–µ–Ω–∏–º —Å–æ—á–µ—Ç–∞–Ω–∏—è (–ª–æ–∫–∞–ª—å–Ω–æ, –ø–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º—É combosCatalog)
      appliedCombos = [];
      try {
        const doneCatalogIds = new Set();
        parsed.forEach(item=>{
          if (item.type === 'habit' && item.success && item.catalogId) {
            doneCatalogIds.add(Number(item.catalogId));
          } else if (item.type === 'composite_habit') {
            item.subtasks.forEach(st=>{
              if (st.success && st.catalogId) doneCatalogIds.add(Number(st.catalogId));
            });
          }
        });
        combosCatalog.forEach(c=>{
          const a = Number(c.habit_a), b = Number(c.habit_b);
          if (doneCatalogIds.has(a) && doneCatalogIds.has(b)) {
            // –ø—Ä–∏–º–µ–Ω–∏–º –±–æ–Ω—É—Å—ã
            totals.I += Number(c.i || 0);
            totals.S += Number(c.s || 0);
            totals.W += Number(c.w || 0);
            totals.E += Number(c.e || 0);
            totals.C += Number(c.c || 0);
            totals.H += Number(c.h || 0);
            totals.ST += Number(c.st || 0);
            totals.$ += Number(c.money || 0);
            appliedCombos.push(c);
          }
        });
      } catch(e){
        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–æ—á–µ—Ç–∞–Ω–∏–π:', e);
      }      

      return totals;
    }
    
    function renderTotalStats(totals) {
      const container = document.getElementById('totalStats');
      if (!container) return;
      
      container.innerHTML = '';
      
      const stats = [
        { key: 'I', label: '–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç' },
        { key: 'S', label: '–°–∏–ª–∞' },
        { key: 'W', label: '–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å' },
        { key: 'E', label: '–≠–º–æ—Ü–∏–∏' },
        { key: 'C', label: '–•–∞—Ä–∏–∑–º–∞' },
        { key: 'H', label: '–ó–¥–æ—Ä–æ–≤—å–µ' },
        { key: 'ST', label: '–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å' },
        { key: '$', label: '–î–µ–Ω—å–≥–∏' }
      ];
      
      stats.forEach(stat => {
        const div = document.createElement('div');
        div.className = 'stat-item';
        div.innerHTML = `
          <div>${stat.label}</div>
          <div class="stat-value">${totals[stat.key].toFixed(2)}</div>
          <div id="change-${stat.key}" class="stat-change"></div>
        `;
        container.appendChild(div);
      });
    }
    
    // –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –ë–î

  function loadCombinations(){
    fetch('/api/combinations')
      .then(r => r.json())
      .then(data => {
        if (data.status === 'success') {
          combosCatalog = data.data || [];
          updateCombinationsModal();
          // –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å parsed ‚Äî –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ–º, —á—Ç–æ–±—ã –æ—Ç—á—ë—Ç –ø–æ–∫–∞–∑–∞–ª –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è
          renderMeta();
          updateReportOutput();
        }
      })
      .catch(err => console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—á–µ—Ç–∞–Ω–∏–π:', err));
  }


    function loadHabitsCatalog() {
      fetch('/api/habits')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            habitsCatalog = data.data;
            updateHabitCatalogModal();
            loadStreaks();
          }
        })
        .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–≤—ã—á–µ–∫:', error));
    }
    
	function loadStreaks() {
	  return fetch('/api/stats/streaks')
		.then(response => response.json())
		.then(data => {
		  if (data.status === 'success') {
			streaksData = {};
			data.data.forEach(streak => {
			  // –∫–ª—é—á –≤—Å–µ–≥–¥–∞ —Å—Ç—Ä–æ–∫–∞
			  const key = String(streak.habit_id);
			  streaksData[key] = {
				current: Number(streak.current_streak) || 0,
				longest: Number(streak.longest_streak) || 0
			  };
			});
			if (parsed.length > 0) {
			  renderTasks();
			}
		  }
		})
		.catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∏–∫–æ–≤:', error));
	}


    
    function loadPeriodStats(period) {
      fetch(`/api/stats/period?period=${period}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            displayPeriodStats(data, period);
          }
        })
        .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error));
    }
    
    function displayPeriodStats(data, period) {
      const container = document.getElementById('periodStatsDisplay');
      if (!container) return;
      
      const periodNames = { week: '–Ω–µ–¥–µ–ª—é', month: '–º–µ—Å—è—Ü', all: '–≤—Å–µ –≤—Ä–µ–º—è' };
      
      let html = `<strong>–ó–∞ ${periodNames[period]}:</strong> `;
      html += `${data.stats.days_count || 0} –¥–Ω–µ–π, `;
      html += `I:${data.stats.avg_i ? data.stats.avg_i.toFixed(2) : '0.00'} `;
      html += `S:${data.stats.avg_s ? data.stats.avg_s.toFixed(2) : '0.00'} `;
      html += `W:${data.stats.avg_w ? data.stats.avg_w.toFixed(2) : '0.00'}`;
      
      if (data.comparison) {
        html += '<br>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ: ';
        const changes = [];
        Object.keys(data.comparison).forEach(key => {
          if (data.comparison[key] !== '‚Üí') {
            changes.push(`${key}${data.comparison[key]}`);
          }
        });
        if (changes.length > 0) {
          html += changes.join(' ');
        } else {
          html += '–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π';
        }
      }
      
      container.innerHTML = html;
    }
    
    function loadDatesFromDB() {
      fetch('/api/stats/period?period=all')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success' && data.days_data) {
            updateDateSelect(data.days_data);
          }
        })
        .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—Ç:', error));
    }
    
    function updateDateSelect(daysData) {
      const select = document.getElementById('dbDateSelect');
      if (!select) return;
      
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      const dates = [...new Set(daysData.map(day => day.date))].sort().reverse();
      
      dates.forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = date;
        select.appendChild(option);
      });
    }
    
    function loadDayFromDB() {
      const date = document.getElementById('dbDateSelect').value;
      if (!date) return;
      
      fetch(`/api/completions/${date}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            currentDayFromDB = data;
            updateUIFromDB();
          }
        })
        .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–Ω—è:', error));
    }
    
    function updateUIFromDB() {
      if (!currentDayFromDB) return;
      
      if (stateSelect) stateSelect.value = currentDayFromDB.day_data?.state || 'WORK';
      if (thoughtsInput) thoughtsInput.value = currentDayFromDB.day_data?.thoughts || '';
      
      if (currentDayFromDB.day_data?.emotion_morning) {
        document.querySelectorAll('#emotionMorning button').forEach(btn => {
          btn.classList.toggle('active', btn.textContent === currentDayFromDB.day_data.emotion_morning);
        });
      }
      
      let text = '';
      let currentCategory = null;
      
      currentDayFromDB.habits.forEach(habit => {
        if (habit.category !== currentCategory) {
          if (currentCategory) text += '\n';
          currentCategory = habit.category;
          text += `${habit.category}\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n`;
        }
        
        const sign = habit.success ? '+' : '-';
        const quantity = habit.quantity ? ` ‚Äî ${habit.quantity} ${habit.unit || ''}` : '';
        const stats = formatStats({
          I: habit.i, S: habit.s, W: habit.w, E: habit.e,
          C: habit.c, H: habit.h, ST: habit.st, $: habit.money
        });
        
        text += `${sign} ${habit.habit_name}${quantity} ${stats}\n`;
      });
      
      if (tasksInput) tasksInput.value = text;
      
      parsed = parseTextToStructure(text);
      renderTasks();
      renderMeta();
      
      loadDailyComparison();
    }

  function loadAllTimeTotals() {
    fetch(`/api/stats/period?period=all`)
      .then(r => r.json())
      .then(data => {
        if (data && data.status === 'success') {
          const s = data.stats || {};

          // 1) –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª —è–≤–Ω—ã–µ —Å—É–º–º–∞—Ä–Ω—ã–µ –ø–æ–ª—è (sum_i –∏ —Ç.–¥.) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
          if (s.sum_i !== undefined || s.sum_s !== undefined || s.sum_w !== undefined) {
            allTimeTotals = {
              I: Number(s.sum_i || 0),
              S: Number(s.sum_s || 0),
              W: Number(s.sum_w || 0),
              E: Number(s.sum_e || 0),
              C: Number(s.sum_c || 0),
              H: Number(s.sum_h || 0),
              ST: Number(s.sum_st || 0),
              $: Number(s.sum_money || 0)
            };
            updateReportOutput();
            return;
          }

          // 2) –ò–Ω–∞—á–µ –∞–∫–∫—É–º—É–ª–∏—Ä—É–µ–º –ø–æ –¥–Ω—è–º (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã day.*)
          if (Array.isArray(data.days_data)) {
            const tot = { I:0, S:0, W:0, E:0, C:0, H:0, ST:0, $:0 };
            data.days_data.forEach(day => {
              // 2a) –µ—Å–ª–∏ day.totals –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
              if (day.totals) {
                tot.I += Number(day.totals.I || day.totals.i || 0);
                tot.S += Number(day.totals.S || day.totals.s || 0);
                tot.W += Number(day.totals.W || day.totals.w || 0);
                tot.E += Number(day.totals.E || day.totals.e || 0);
                tot.C += Number(day.totals.C || day.totals.c || 0);
                tot.H += Number(day.totals.H || day.totals.h || 0);
                tot.ST += Number(day.totals.ST || day.totals.st || 0);
                tot.$ += Number(day.totals.$ || day.totals.money || 0);
                return;
              }

              // 2b) –µ—Å–ª–∏ day.habits ‚Äî —Å—É–º–º–∏—Ä—É–µ–º –ø–æ –ø—Ä–∏–≤—ã—á–∫–∞–º
              if (day.habits && Array.isArray(day.habits)) {
                day.habits.forEach(h => {
                  tot.I += Number(h.i || h.I || 0);
                  tot.S += Number(h.s || h.S || 0);
                  tot.W += Number(h.w || h.W || 0);
                  tot.E += Number(h.e || h.E || 0);
                  tot.C += Number(h.c || h.C || 0);
                  tot.H += Number(h.h || h.H || 0);
                  tot.ST += Number(h.st || h.ST || 0);
                  tot.$ += Number(h.money || h.$ || 0);
                });
                return;
              }

              // 2c) –°–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å –æ–±—ä–µ–∫—Ç –¥–Ω—è —Å –ø—Ä—è–º—ã–º–∏ –ø–æ–ª—è–º–∏ I,S,W...
              tot.I += Number(day.I || day.i || 0);
              tot.S += Number(day.S || day.s || 0);
              tot.W += Number(day.W || day.w || 0);
              tot.E += Number(day.E || day.e || 0);
              tot.C += Number(day.C || day.c || 0);
              tot.H += Number(day.H || day.h || 0);
              tot.ST += Number(day.ST || day.st || 0);
              tot.$ += Number(day.sum_money || day.sum_money || day.money || 0);
            });

            allTimeTotals = tot;
            updateReportOutput();
            return;
          }
        }

        // fallback ‚Äî –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
        allTimeTotals = null;
        updateReportOutput();
      })
      .catch(err => {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—É–º–º–∞—Ä–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è:', err);
        allTimeTotals = null;
        updateReportOutput();
      });
  }

    
	function loadDailyComparison() {
	  const today = toISODate(new Date());
	  fetch(`/api/stats/daily_comparison?date=${today}`)
		.then(response => response.json())
		.then(data => {
		  if (data.status === 'success' && data.comparison) {
			dailyComparison = data.comparison; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –æ—Ç—á—ë—Ç–µ
			// –û–±–Ω–æ–≤–ª—è–µ–º DOM-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
			Object.keys(data.comparison).forEach(key => {
			  const changeEl = document.getElementById(`change-${key}`);
			  if (changeEl) {
				const sign = data.comparison[key];
				changeEl.textContent = sign;
				changeEl.className = `stat-change ${sign === '‚Üë' ? 'up' : sign === '‚Üì' ? 'down' : 'same'}`;
			  }
			});
			updateReportOutput();
		  } else {
			dailyComparison = null;
			updateReportOutput();
		  }
		})
		.catch(error => {
		  console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:', error);
		  dailyComparison = null;
		  updateReportOutput();
		});
	}

    
	function saveDayToDB() {
	  const date = toISODate(new Date());
	  const state = stateSelect ? stateSelect.value : 'WORK';
	  const thoughts = thoughtsInput ? thoughtsInput.value : '';
	  
	  const emotionBtn = document.querySelector('#emotionMorning button.active');
	  const emotionMorning = emotionBtn ? emotionBtn.textContent : null;
	  
	  const habitsData = [];
	  parsed.forEach(item => {
		if (item.type === 'habit' && !item.isSubtask) {  // –î–æ–±–∞–≤–ª–µ–Ω–æ: —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏
		  const catalogHabit = habitsCatalog.find(h => 
			h.name === item.name && h.category === item.category  // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é
		  );
		  
		  if (catalogHabit) {
			habitsData.push({
			  habit_id: catalogHabit.id,
			  quantity: item.quantity,
			  success: item.success,
			  i: item.stats.I,
			  s: item.stats.S,
			  w: item.stats.W,
			  e: item.stats.E,
			  c: item.stats.C,
			  h: item.stats.H,
			  st: item.stats.ST,
			  money: item.stats.$
			});
		  }
		}
	  });
	  
	  const postData = {
		date: date,
		state: state,
		emotion_morning: emotionMorning,
		thoughts: thoughts,
		habits: habitsData,
		day_number: currentDayDisplay ? parseInt(currentDayDisplay.textContent) || 1 : 1,
		completed_count: completedCountEl ? parseInt(completedCountEl.textContent) || 0 : 0,
		total_count: totalCountEl ? parseInt(totalCountEl.textContent) || 0 : 0,
		totals: calculateTotalStats(parsed)
	  };
	  
	  fetch('/api/completions', {
		method: 'POST',
		headers: {
		  'Content-Type': 'application/json'
		},
		body: JSON.stringify(postData)
	  })
	  .then(response => response.json())
	  .then(data => {
		if (data.status === 'success') {
		  alert('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö!');
		  loadDatesFromDB();
		  loadStreaks();
		  // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∏–∫–∏ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
		  setTimeout(() => {
			loadStreaks();
			renderTasks(); // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞—á —Å–æ —Å—Ç—Ä–∏–∫–∞–º–∏
		  }, 500);
		} else {
		  alert('–û—à–∏–±–∫–∞: ' + data.message);
		}
	  })
	  .catch(error => {
		console.error('–û—à–∏–±–∫–∞:', error);
		alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
	  });
	}
    
    function updateCombinationsModal(){
      const list = document.getElementById('comboList');
      const selA = document.getElementById('comboA');
      const selB = document.getElementById('comboB');
      if(!list || !selA || !selB) return;
      list.innerHTML = '';
      selA.innerHTML = '<option value="">‚Äî</option>';
      selB.innerHTML = '<option value="">‚Äî</option>';
      habitsCatalog.forEach(h=>{
        const opt = `<option value="${h.id}">${h.name} (${h.category})</option>`;
        selA.insertAdjacentHTML('beforeend', opt);
        selB.insertAdjacentHTML('beforeend', opt);
      });
      if(combosCatalog.length === 0){
        list.innerHTML = '<div class="small">–°–æ—á–µ—Ç–∞–Ω–∏–π –Ω–µ—Ç</div>';
      } else {
        combosCatalog.forEach(c=>{
          const name = c.name || `${c.name_a || ''} + ${c.name_b || ''}`;
          const html = `<div style="padding:6px;border-bottom:1px solid #eee">
            <strong>${name}</strong><div class="small">(${c.name_a || c.habit_a} ‚Üî ${c.name_b || c.habit_b})</div>
            <div class="small">${formatStats({I:c.i||0,S:c.s||0,W:c.w||0,E:c.e||0,C:c.c||0,H:c.h||0,ST:c.st||0,$:c.money||0})}</div>
          </div>`;
          list.insertAdjacentHTML('beforeend', html);
        });
      }
    }

    function openCombos(){
      showModal('comboModal');
      updateCombinationsModal();
    }

    function createCombo(){
      const a = document.getElementById('comboA').value;
      const b = document.getElementById('comboB').value;
      if(!a || !b || a === b){
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–µ —Ä–∞–∑–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏');
        return;
      }
      const payload = {
        name: document.getElementById('comboName').value || null,
        habit_a: Math.min(Number(a), Number(b)),
        habit_b: Math.max(Number(a), Number(b)),
        i: parseFloat(document.getElementById('comboI').value || 0),
        s: parseFloat(document.getElementById('comboS').value || 0),
        w: parseFloat(document.getElementById('comboW').value || 0),
        e: parseFloat(document.getElementById('comboE').value || 0),
        c: parseFloat(document.getElementById('comboC').value || 0),
        h: parseFloat(document.getElementById('comboH').value || 0),
        st: parseFloat(document.getElementById('comboST').value || 0),
        money: parseFloat(document.getElementById('comboMoney').value || 0)
      };
      fetch('/api/combinations', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      }).then(r=>r.json()).then(data=>{
        if(data.status === 'success'){
          alert('–°–æ–∑–¥–∞–Ω–æ');
          loadCombinations();
          hideModal('comboModal');
        } else alert('–û—à–∏–±–∫–∞: '+(data.message||''));
      }).catch(err=>{console.warn(err); alert('–û—à–∏–±–∫–∞');});
    }


    function updateHabitCatalogModal() {
      const container = document.getElementById('habitCatalogList');
      if (!container) return;
      
      container.innerHTML = '';
      
      const habitsByCategory = {};
      habitsCatalog.forEach(habit => {
        if (!habitsByCategory[habit.category]) {
          habitsByCategory[habit.category] = [];
        }
        habitsByCategory[habit.category].push(habit);
      });
      
      Object.keys(habitsByCategory).sort().forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'category-header';
        categoryDiv.textContent = category;
        container.appendChild(categoryDiv);
        
        habitsByCategory[category].forEach(habit => {
          const habitDiv = document.createElement('div');
          habitDiv.className = 'habit-option';
          habitDiv.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
              <div>
                <strong>${habit.name}</strong>
                <span class="small">${habit.default_quantity ? ` ‚Äî ${habit.default_quantity} ${habit.unit || ''}` : ''}</span>
              </div>
              <div class="small">${formatStats({
                I: habit.i, S: habit.s, W: habit.w, E: habit.e,
                C: habit.c, H: habit.h, ST: habit.st, $: habit.money
              })}</div>
            </div>
          `;
          
          habitDiv.onclick = function() {
            addHabitFromCatalog(habit);
            hideModal('habitCatalogModal');
          };
          
          container.appendChild(habitDiv);
        });
      });
    }
    
    function filterHabits() {
      const search = document.getElementById('habitSearch').value.toLowerCase();
      const options = document.querySelectorAll('.habit-option');
      
      options.forEach(option => {
        const text = option.textContent.toLowerCase();
        option.style.display = text.includes(search) ? '' : 'none';
      });
      
      const categories = document.querySelectorAll('.category-header');
      categories.forEach(category => {
        const nextElements = [];
        let next = category.nextElementSibling;
        while (next && next.classList.contains('habit-option')) {
          nextElements.push(next);
          next = next.nextElementSibling;
        }
        
        const hasVisible = nextElements.some(el => el.style.display !== 'none');
        category.style.display = hasVisible ? '' : 'none';
      });
    }
    
	// --- –£—Ç–∏–ª–∏—Ç—ã: –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫ –ø—Ä–∏–≤—ã—á–∫–∏ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ ---
	function normalize(str){
	  return (str||'').toString().trim().toLowerCase();
	}

	function findCatalogHabitByItem(item){
	  if(!item) return null;
	  // —Å–Ω–∞—á–∞–ª–∞ –ø–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–º—É catalogId
	  if(item.catalogId){
		const byId = habitsCatalog.find(h => String(h.id) === String(item.catalogId));
		if(byId) return byId;
	  }
	  // —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ name+category
	  let found = habitsCatalog.find(h =>
		normalize(h.name) === normalize(item.name) &&
		normalize(h.category) === normalize(item.category)
	  );
	  if(found) return found;
	  // fallback ‚Äî –ø–æ –∏–º–µ–Ω–∏ —Ç–æ–ª—å–∫–æ
	  found = habitsCatalog.find(h => normalize(h.name) === normalize(item.name));
	  return found || null;
	}

	function addHabitFromCatalog(habit) {
	  if (!tasksInput) return;
	  const sign = '+';
	  const quantity = habit.default_quantity ? ` ‚Äî ${habit.default_quantity} ${habit.unit || ''}` : '';
	  const stats = formatStats({
		I: habit.i, S: habit.s, W: habit.w, E: habit.e,
		C: habit.c, H: habit.h, ST: habit.st, $: habit.money
	  });
	  const habitLine = `${sign} ${habit.name}${quantity} ${stats}`;

	  const cat = (habit.category || '').trim();
	  const raw = tasksInput.value || '';
	  const lines = raw.split('\n');

	  // –ù–∞–π–¥—ë–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Å—Ç—Ä–æ–∫–∞ —Ç–æ—á–Ω–æ —Ä–∞–≤–Ω–∞ –∏–º–µ–Ω–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
	  let insertIndex = -1;
	  for (let i = 0; i < lines.length; i++) {
		if (lines[i].trim() === cat) {
		  // –ï—Å–ª–∏ —Å–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å ‚Äî –≤—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –Ω–µ–≥–æ
		  if (i + 1 < lines.length && /^‚Äî+$/.test(lines[i + 1].trim())) {
			insertIndex = i + 2;
		  } else {
			insertIndex = i + 1;
		  }
		  break;
		}
	  }

	  if (insertIndex === -1) {
		// –ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ ‚Äî –¥–æ–±–∞–≤–∏–º –±–ª–æ–∫ –≤ –∫–æ–Ω–µ—Ü –∞–∫–∫—É—Ä–∞—Ç–Ω–æ
		let newText = raw.trimEnd();
		if (newText.length) newText += '\n';
		newText += `${cat}\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n${habitLine}\n`;
		tasksInput.value = newText;
	  } else {
		// –í—Å—Ç–∞–≤–ª—è–µ–º –≤ –Ω–∞–π–¥–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ
		lines.splice(insertIndex, 0, habitLine);
		tasksInput.value = lines.join('\n');
	  }

	  // –ü–µ—Ä–µ–∑–∞–ø–∞—Ä—Å–∏–º –∏ –ø—Ä–æ—Å—Ç–∞–≤–∏–º catalogId —É –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –ø–æ –∏–º–µ–Ω–∏ –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
	  parsed = parseTextToStructure(tasksInput.value);
	  parsed.forEach(p => {
		if (p.type === 'habit' && normalize(p.name) === normalize(habit.name)) {
		  // –µ—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ª–∏–±–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç, –ª–∏–±–æ –ø—É—Å—Ç–∞ ‚Äî –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º
		  if (!p.category || normalize(p.category) === normalize(habit.category)) {
			p.category = habit.category;
			p.catalogId = habit.id;
		  }
		}
		if (p.type === 'composite_habit') {
		  p.subtasks.forEach(st => {
			if (normalize(st.name) === normalize(habit.name)) {
			  if (!st.category || normalize(st.category) === normalize(habit.category)) {
				st.category = habit.category;
				st.catalogId = habit.id;
			  }
			}
		  });
		}
	  });

	  renderTasks();
	  renderMeta();
	  saveStateToLocal();
	}


    
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.style.display = 'flex';
    }
    
    function hideModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.style.display = 'none';
    }
    
    // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    function parseTextToStructure(text){
      const lines = text.replace(/\r/g,'').split('\n');
      const out = [];
      let currentComposite = null;
      let currentCategory = null;

      for(let i = 0; i < lines.length; i++){
        const raw = lines[i];
        const trimmed = raw.trim();
        
        if(!trimmed){
          out.push({ type:'blank' });
          continue;
        }

        if(/^‚Äî+$/.test(trimmed)){
          continue;
        }

        if(!/^[*+-]/.test(trimmed) && !trimmed.endsWith(':')){
          currentCategory = trimmed;
          out.push({ 
            type: 'category', 
            text: trimmed,
            rawText: raw
          });
          currentComposite = null;
          continue;
        }
        
        if(/^\*/.test(trimmed)){
          const text = trimmed.replace(/^\*\s*/, '');
          const composite = {
            type: 'composite_habit',
            text: text,
            subtasks: [],
            category: currentCategory,
            rawText: raw
          };
          out.push(composite);
          currentComposite = composite;
          continue;
        }

        if(/^[+-]/.test(trimmed)){
          const success = trimmed[0] === '+';
          const rest = trimmed.substring(1).trim();
          
          const isSubtask = raw.startsWith(' ') || raw.startsWith('\t');
          
          const dashIndex = rest.indexOf(' ‚Äî ');
          let name = rest;
          let quantity = null;
          let unit = null;
          let statsText = '';
          
          if(dashIndex !== -1){
            name = rest.substring(0, dashIndex).trim();
            const afterDash = rest.substring(dashIndex + 3).trim();
            
            const statsMatch = afterDash.match(/(.+?)\s+(I\[.+?\])$/);
            if(statsMatch){
              const beforeStats = statsMatch[1];
              statsText = statsMatch[2];
              
              const quantityMatch = beforeStats.match(/^(\d+(?:\.\d+)?)\s+(.+)$/);
              if(quantityMatch){
                quantity = parseFloat(quantityMatch[1]);
                unit = quantityMatch[2];
              }
            } else {
              statsText = afterDash;
            }
          } else {
            const statsMatch = rest.match(/(.+?)\s+(I\[.+?\])$/);
            if(statsMatch){
              name = statsMatch[1].trim();
              statsText = statsMatch[2];
            }
          }
          
          const stats = parseCharacteristics(statsText);
          
          const habit = {
            type: 'habit',
            text: raw,
            name: name,
            success: success,
            quantity: quantity,
            unit: unit,
            stats: stats,
            category: currentCategory,
            isSubtask: isSubtask,
            rawText: raw
          };
          
          if(isSubtask && currentComposite){
            currentComposite.subtasks.push(habit);
          } else {
            out.push(habit);
            currentComposite = null;
          }
          continue;
        }
      }
      return out;
    }

	function showEditHabitModal(idx) {
	  const item = parsed[idx];
	  if(!item) return;
	  document.getElementById('editIndex').value = idx;
	  document.getElementById('editName').value = item.name || '';
	  document.getElementById('editCategory').value = item.category || '';
	  document.getElementById('editQuantity').value = item.quantity || '';
	  document.getElementById('editUnit').value = item.unit || '';
	  document.getElementById('editSuccess').value = item.success ? '1' : '0';
	  showModal('habitEditModal');
	}

	document.getElementById('saveEditBtn')?.addEventListener('click', () => {
	  const idx = parseInt(document.getElementById('editIndex').value, 10);
	  const item = parsed[idx];
	  if(!item) return hideModal('habitEditModal');

	  item.name = document.getElementById('editName').value.trim();
	  item.category = document.getElementById('editCategory').value.trim();
	  const q = document.getElementById('editQuantity').value.trim();
	  item.quantity = q ? parseFloat(q) : null;
	  item.unit = document.getElementById('editUnit').value.trim();
	  item.success = document.getElementById('editSuccess').value === '1';

	  // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ (–µ—Å–ª–∏ —É —ç—Ç–æ–π –ø—Ä–∏–≤—ã—á–∫–∏ –µ—Å—Ç—å catalogHabit)
	  const catalogHabit = habitsCatalog.find(h => (h.name||'').trim().toLowerCase() === item.name.trim().toLowerCase());
	  if (catalogHabit) {
		// –ü—Ä–∏–º–µ—Ä: –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î
		// fetch(`/api/habits/${catalogHabit.id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: item.name, category: item.category }) })
		//   .then(()=>{/* reload catalog if –Ω–∞–¥–æ */});
	  }

	  hideModal('habitEditModal');
	  renderTasks();
	  renderMeta();
	  saveStateToLocal();
	});

    
	// --- renderTasks: –±–æ–ª–µ–µ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º catalogHabit, –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ–º catalogId, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∏–∫–∏ ---
	function renderTasks(){
	  const tasksListEl = document.getElementById('tasksList');
	  if (!tasksListEl) return;
	  tasksListEl.innerHTML = '';
	  let currentCategory = null;

	  parsed.forEach((item, idx) => {
		if(item.type === 'blank'){
		  const br = document.createElement('div');
		  br.style.height = '8px';
		  tasksListEl.appendChild(br);
		  return;
		}

		if(item.type === 'category'){
		  currentCategory = item.text;
		  const s = document.createElement('div');
		  s.className = 'section';
		  const h = document.createElement('h3');
		  h.textContent = item.text;
		  s.appendChild(h);
		  tasksListEl.appendChild(s);
		  return;
		}

		if(item.type === 'habit'){
		  // –ü–æ–ø—Ä–æ–±—É–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
		  let catalogHabit = findCatalogHabitByItem(item);
		  if (!catalogHabit && currentCategory) {
			// –ø—Ä–æ–±—É–µ–º –ø–æ —Ç–µ–∫—É—â–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ + –∏–º–µ–Ω–∏
			catalogHabit = habitsCatalog.find(h => normalize(h.name) === normalize(item.name) && normalize(h.category) === normalize(currentCategory));
		  }
		  if (catalogHabit) {
			item.catalogId = catalogHabit.id; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
		  }

		  const el = document.createElement('div');
		  el.className = 'task';
		  if (catalogHabit) el.classList.add('habit-from-db');
		  el.style.display = 'flex';
		  el.style.alignItems = 'center';
		  el.style.gap = '8px';
		  el.style.padding = '8px';
		  el.style.border = '1px solid #eee';
		  el.style.borderRadius = '6px';
		  el.style.margin = '4px 0';

		  const btn = document.createElement('button');
		  btn.className = 'toggle';
		  btn.textContent = item.success ? '[+]' : '[-]';
		  btn.onclick = () => {
			item.success = !item.success;
			btn.textContent = item.success ? '[+]' : '[-]';
			renderMeta();
			updateReportOutput();
			saveStateToLocal();
		  };

		  const textContainer = document.createElement('div');
		  textContainer.style.flex = '1';
		  textContainer.style.display = 'flex';
		  textContainer.style.alignItems = 'center';
		  textContainer.style.justifyContent = 'space-between';

		  const mainText = document.createElement('div');
		  let nameText = item.name || '';
		  if(item.quantity){
			nameText += ` ‚Äî ${item.quantity} ${item.unit || ''}`;
		  }

			// ...
			let streakHtml = '';
			if (catalogHabit) {
			  const key = String(catalogHabit.id);
			  const s = streaksData && streaksData[key];
			  if (s) {
				// –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 0 —Ç–∞–∫–∂–µ ‚Äî –≤–∏–∑—É–∞–ª—å–Ω–æ —ç—Ç–æ –±—É–¥–µ—Ç üî•0
				streakHtml = `<span class="streak-fire" title="–°—Ç—Ä–∏–∫: ${s.current} –¥–Ω–µ–π (—Ä–µ–∫–æ—Ä–¥: ${s.longest})">üî•${s.current}</span>`;
			  }
			}
			// ...


		  mainText.innerHTML = `${nameText} ${streakHtml}`;

		  const controlsDiv = document.createElement('div');
		  controlsDiv.className = 'habit-controls';

		  if (catalogHabit) {
			const removeBtn = document.createElement('button');
			removeBtn.className = 'small';
			removeBtn.textContent = '√ó';
			removeBtn.title = '–£–¥–∞–ª–∏—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞';
			removeBtn.onclick = (e) => {
			  e.stopPropagation();
			  removeHabitFromText(item.name, currentCategory);
			};
			controlsDiv.appendChild(removeBtn);
		  } else {
			const addToCatalogBtn = document.createElement('button');
			addToCatalogBtn.className = 'small';
			addToCatalogBtn.textContent = '+ –≤ –ë–î';
			addToCatalogBtn.title = '–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫';
			addToCatalogBtn.onclick = (e) => {
			  e.stopPropagation();
			  addNewHabitToCatalog(item, currentCategory);
			};
			controlsDiv.appendChild(addToCatalogBtn);
		  }

		  const editBtn = document.createElement('button');
		  editBtn.className = 'small';
		  editBtn.textContent = '‚úé';
		  editBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
		  editBtn.onclick = (e) => { e.stopPropagation(); showEditHabitModal(idx); };
		  controlsDiv.appendChild(editBtn);

		  textContainer.appendChild(mainText);
		  textContainer.appendChild(controlsDiv);

		  el.appendChild(btn);
		  el.appendChild(textContainer);
		  tasksListEl.appendChild(el);
		}

		if(item.type === 'composite_habit'){
		  // –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–æ—Å—Ç–∞–≤–Ω–æ–π –ø—Ä–∏–≤—ã—á–∫–∏ –∏ –ø–æ–¥–∑–∞–¥–∞—á–∏
		  const compHeader = document.createElement('div');
		  compHeader.className = 'section';
		  compHeader.innerHTML = `<strong>üß© ${item.text}</strong>`;
		  tasksListEl.appendChild(compHeader);

		  item.subtasks.forEach((st, si) => {
			// –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É —á—Ç–æ –∏ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏)
			const fakeIdx = `${idx}-sub-${si}`;
			// –ø—Ä–æ—Å—Ç–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞
			const el = document.createElement('div');
			el.className = 'task';
			el.style.display = 'flex';
			el.style.alignItems = 'center';
			el.style.gap = '8px';
			el.style.padding = '6px 8px';
			el.style.border = '1px solid #eee';
			el.style.borderRadius = '6px';
			el.style.margin = '4px 0';

			const btn = document.createElement('button');
			btn.className = 'toggle';
			btn.textContent = st.success ? '[+]' : '[-]';
			btn.onclick = () => {
			  st.success = !st.success;
			  btn.textContent = st.success ? '[+]' : '[-]';
			  renderMeta();
			  updateReportOutput();
			  saveStateToLocal();
			};

			const mainText = document.createElement('div');
			let nameText = st.name || '';
			if (st.quantity) nameText += ` ‚Äî ${st.quantity} ${st.unit || ''}`;

			// –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –ë–î
			const catalogHabit = findCatalogHabitByItem(st);
			if (catalogHabit) {
			  st.catalogId = catalogHabit.id;
			  const key = String(catalogHabit.id);
			  if (streaksData && streaksData[key] && streaksData[key].current > 0) {
				nameText += ` <span class="streak-fire" title="–°—Ç—Ä–∏–∫: ${streaksData[key].current} –¥–Ω–µ–π">üî•${streaksData[key].current}</span>`;
			  }
			}

			mainText.innerHTML = nameText;

			const controlsDiv = document.createElement('div');
			controlsDiv.className = 'habit-controls';

			if (catalogHabit) {
			  const removeBtn = document.createElement('button');
			  removeBtn.className = 'small';
			  removeBtn.textContent = '√ó';
			  removeBtn.title = '–£–¥–∞–ª–∏—Ç—å';
			  removeBtn.onclick = (e) => { e.stopPropagation(); removeHabitFromText(st.name, currentCategory); };
			  controlsDiv.appendChild(removeBtn);
			} else {
			  const addBtn = document.createElement('button');
			  addBtn.className = 'small';
			  addBtn.textContent = '+ –≤ –ë–î';
			  addBtn.onclick = (e) => { e.stopPropagation(); addNewHabitToCatalog(st, currentCategory); };
			  controlsDiv.appendChild(addBtn);
			}

			el.appendChild(btn);
			el.appendChild(mainText);
			el.appendChild(controlsDiv);
			tasksListEl.appendChild(el);
		  });
		}
	  });
	}
	 // --- saveEditBtn: –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ë–î, –µ—Å–ª–∏ –µ—Å—Ç—å catalogId ---
	document.getElementById('saveEditBtn')?.addEventListener('click', () => {
	  const idx = parseInt(document.getElementById('editIndex').value, 10);
	  const item = parsed[idx];
	  if(!item) return hideModal('habitEditModal');

	  item.name = document.getElementById('editName').value.trim();
	  item.category = document.getElementById('editCategory').value.trim();
	  const q = document.getElementById('editQuantity').value.trim();
	  item.quantity = q ? parseFloat(q) : null;
	  item.unit = document.getElementById('editUnit').value.trim();
	  item.success = document.getElementById('editSuccess').value === '1';

	  // –µ—Å–ª–∏ —Å–≤—è–∑–∞–Ω–∞ –∑–∞–ø–∏—Å—å –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –µ—ë –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
	  const catalogHabit = findCatalogHabitByItem(item);
	  if (catalogHabit) {
		const habitUpdate = {
		  name: item.name,
		  category: item.category || catalogHabit.category,
		  default_quantity: item.quantity || catalogHabit.default_quantity || null,
		  unit: item.unit || catalogHabit.unit || null
		};
		fetch(`/api/habits/${catalogHabit.id}`, {
		  method: 'PUT',
		  headers: {'Content-Type':'application/json'},
		  body: JSON.stringify(habitUpdate)
		})
		.then(r => r.json())
		.then(data => {
		  if (data.status === 'success') {
			// –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫, —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å id/–∫–∞—Ç–µ–≥–æ—Ä–∏–∏/—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
			loadHabitsCatalog();
		  } else {
			console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É –≤ –ë–î:', data);
		  }
		})
		.catch(err => console.warn('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏–≤—ã—á–∫–∏:', err));
	  }

	  hideModal('habitEditModal');
	  renderTasks();
	  renderMeta();
	  saveStateToLocal();
	});   
	
    function removeHabitFromText(habitName, category) {
      if (!tasksInput) return;
      
      let lines = tasksInput.value.split('\n');
      lines = lines.filter(line => {
        const trimmed = line.trim();
        return !(trimmed.startsWith('+') || trimmed.startsWith('-')) || 
               !trimmed.includes(habitName);
      });
      
      tasksInput.value = lines.join('\n');
      parsed = parseTextToStructure(tasksInput.value);
      renderTasks();
      renderMeta();
    }
    
	function addNewHabitToCatalog(habit, category) {
	  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ —Ñ—É–Ω–∫—Ü–∏–∏
	  const habitData = {
		name: habit.name,
		category: category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏',  // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –±–µ—Ä–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
		default_quantity: habit.quantity || null,
		unit: habit.unit || null,
		i: habit.stats.I,
		s: habit.stats.S,
		w: habit.stats.W,
		e: habit.stats.E,
		c: habit.stats.C,
		h: habit.stats.H,
		st: habit.stats.ST,
		money: habit.stats.$
	  };
      
      fetch('/api/habits', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(habitData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert('–ü—Ä–∏–≤—ã—á–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫!');
          loadHabitsCatalog();
        } else {
          alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
      })
      .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
      });
    }
    
    function renderMeta(){
      if (!todayDisplay || !currentDayDisplay || !diffDaysEl || !completedCountEl || !totalCountEl || !percentDoneEl || !stateDesc) return;
      
      const today = new Date();
      todayDisplay.textContent = toISODate(today);
      const lastDateVal = lastDateEl.value ? new Date(lastDateEl.value) : null;
      const lastDayVal = Number(lastDayEl.value || 0);
      if(lastDateVal){
        const diff = daysBetween(lastDateVal, today);
        diffDaysEl.textContent = diff;
        currentDayDisplay.textContent = String(lastDayVal + diff);
      } else {
        diffDaysEl.textContent = '‚Äî';
        currentDayDisplay.textContent = String(lastDayVal || 0);
      }
      
      const total = parsed.filter(p => p.type === 'habit').length + 
                   parsed.filter(p => p.type === 'composite_habit').reduce((sum, c) => sum + c.subtasks.length, 0);
      const completed = parsed.filter(p => p.type === 'habit' && p.success).length +
                       parsed.filter(p => p.type === 'composite_habit').reduce((sum, c) => sum + c.subtasks.filter(s => s.success).length, 0);
      
      totalCountEl.textContent = total;
      completedCountEl.textContent = completed;
      const pct = total === 0 ? 0 : Math.round((completed/total)*100);
      percentDoneEl.textContent = pct + '%';
      stateDesc.textContent = STATE_DESCRIPTIONS[stateSelect.value] || '';
      
      const totals = calculateTotalStats(parsed);
      renderTotalStats(totals);
    }
	// –≤ –∫–æ–Ω—Ü–µ renderMeta()
	try { loadDailyComparison(); } catch(e) { console.warn('compare load failed', e); }


  // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç { total, completed, notCompleted, percent }.
  // –£—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏ –∏ subtasks –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫.
  function computeCompletionStats(parsed) {
    let total = 0;
    let completed = 0;

    parsed.forEach(item => {
      // –û–±—ã—á–Ω–∞—è –ø—Ä–∏–≤—ã—á–∫–∞
      if (item.type === 'habit' || item.type === 'simple_habit') {
        total += 1;
        if (item.success) completed += 1;
        return;
      }

      // –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–∏–≤—ã—á–∫–∞ ‚Äî –æ–∂–∏–¥–∞–µ–º item.subtasks = [{ success: bool, ... }, ...]
      if (item.type === 'composite_habit' || item.type === 'habit_group' || Array.isArray(item.subtasks)) {
        if (Array.isArray(item.subtasks) && item.subtasks.length) {
          item.subtasks.forEach(st => {
            total += 1;
            if (st.success) completed += 1;
          });
        } else {
          // –ï—Å–ª–∏ subtasks –Ω–µ —É–∫–∞–∑–∞–Ω—ã, —Å—á–∏—Ç–∞–µ–º —Å–∞–º composite –∫–∞–∫ –æ–¥–Ω–∞ –ø—Ä–∏–≤—ã—á–∫–∞
          total += 1;
          if (item.success) completed += 1;
        }
        return;
      }

      // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π: –µ—Å–ª–∏ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —ç–ª–µ–º–µ–Ω—Ç —Å–æ —Å–≤–æ–π—Å—Ç–≤–æ–º success –∏ catalogId ‚Äî —Å—á–∏—Ç–∞–µ–º –µ–≥–æ
      if ('success' in item) {
        total += 1;
        if (item.success) completed += 1;
      }
    });

    const notCompleted = total - completed;
    const percent = total === 0 ? 0 : Math.round((completed / total) * 10000) / 100; // –¥–≤–∞ –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π

    return { total, completed, notCompleted, percent };
  }


	function buildReportText(){
	  const today = new Date();
	  const todayISO = toISODate(today);
	  const lastDateVal = lastDateEl.value ? new Date(lastDateEl.value) : null;
	  const lastDayVal = Number(lastDayEl.value || 0);
	  let dayNumber = lastDayVal;
	  if(lastDateVal) dayNumber = lastDayVal + daysBetween(lastDateVal, today);

	  const totals = calculateTotalStats(parsed);

	  const lines = [];
	  lines.push(`üìÖ –î–ï–ù–¨ ${dayNumber} ¬∑ ${todayISO}`);
	  lines.push(`üß≠ STATE: ${stateSelect ? stateSelect.value : 'WORK'}`);
	  lines.push('');
	  lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
	  lines.push('üìä –°–£–ú–ú–ê –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö (–∑–∞ –¥–µ–Ω—å)');
	  lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

    if (appliedCombos && appliedCombos.length) {
      lines.push('');
      lines.push('üîó –°–æ—á–µ—Ç–∞–Ω–∏—è (–ø—Ä–∏–º–µ–Ω–µ–Ω—ã –±–æ–Ω—É—Å—ã):');
      appliedCombos.forEach(c => {
        const name = c.name || `${c.name_a || ''} + ${c.name_b || ''}`;
        const parts = [];
        if (Number(c.i)) parts.push(`I:${Number(c.i).toFixed(2)}`);
        if (Number(c.s)) parts.push(`S:${Number(c.s).toFixed(2)}`);
        if (Number(c.w)) parts.push(`W:${Number(c.w).toFixed(2)}`);
        if (Number(c.e)) parts.push(`E:${Number(c.e).toFixed(2)}`);
        if (Number(c.c)) parts.push(`C:${Number(c.c).toFixed(2)}`);
        if (Number(c.h)) parts.push(`H:${Number(c.h).toFixed(2)}`);
        if (Number(c.st)) parts.push(`ST:${Number(c.st)}`);
        if (Number(c.money)) parts.push(`$:${Number(c.money)}`);
        lines.push(`‚Ä¢ ${name} ‚Äî ${parts.join(' ')}`);
      });
      lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
      lines.push('');
    }

	  // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
	  const todaysFormatted = formatTotalsForReport(totals);
	  lines.push(todaysFormatted);

	  // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ (—Å—Ç—Ä–µ–ª–æ—á–∫–∏) –µ—Å–ª–∏ –µ—Å—Ç—å
	  if (dailyComparison) {
		const comps = [];
		const map = { I: 'I', S: 'S', W: 'W', E: 'E', C: 'C', H: 'H', ST: 'ST', $: '$' };
		Object.keys(map).forEach(k => {
		  if (dailyComparison[k]) comps.push(`${k}${dailyComparison[k]}`);
		});
		if (comps.length) lines.push(`–°—Ä–∞–≤–Ω–µ–Ω–∏–µ: ${comps.join(' ')}`);
	  }

	  // –î–æ–±–∞–≤–ª—è–µ–º —Å—É–º–º—É –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞
	  if (allTimeTotals) {
		lines.push('');
		lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
		lines.push('üìä –°–£–ú–ú–ê –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö (–≤—Å—ë –≤—Ä–µ–º—è)');
		lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
		lines.push(formatTotalsForReport(allTimeTotals));
	  }

	  lines.push('');
	  lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
	  lines.push('üß† –°–û–°–¢–û–Ø–ù–ò–ï');
	  lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
	  lines.push(`üåÖ –£—Ç—Ä–æ: ${emotionMorning || '‚Äî'}`);
	  lines.push('');

	  let currentCategory = null;

	  parsed.forEach(item => {
		if(item.type === 'category'){
		  lines.push('');
		  lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
		  lines.push(item.text);
		  lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
		  currentCategory = item.text;
		}

		if(item.type === 'habit' && !item.isSubtask){
		  const icon = item.success ? '‚úÖ' : '‚ùå';
		  let line = `${icon} ${item.name}`;
		  if(item.quantity){
			line += ` ‚Äî ${item.quantity} ${item.unit || ''}`;
		  }
		  // –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–∏–∫, –µ—Å–ª–∏ –µ—Å—Ç—å —Å–≤—è–∑–∞–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ –∏ —Å—Ç—Ä–∏–∫ –¥–æ—Å—Ç—É–ø–µ–Ω
		  const catalogHabit = findCatalogHabitByItem(item);
		  if (catalogHabit) {
			const key = String(catalogHabit.id);
			if (streaksData && streaksData[key]) {
			  line += `  üî•${streaksData[key].current}`;
			}
		  }
		  // –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–Ω—É–ª–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
		  const statsParts = [];
		  ['I','S','W','E','C','H'].forEach(k => {
			if (item.stats && Number(item.stats[k]) !== 0) statsParts.push(`${k}[${Number(item.stats[k]).toFixed(2)}]`);
		  });
		  if (item.stats && (Number(item.stats.ST) || Number(item.stats.$))) {
			if (Number(item.stats.ST) !== 0) statsParts.push(`ST[${Number(item.stats.ST)}]`);
			if (Number(item.stats.$) !== 0) statsParts.push(`$[${Number(item.stats.$)}]`);
		  }
		  if (statsParts.length) line += ' ' + statsParts.join(' ');
		  lines.push(line);
		}

		if(item.type === 'composite_habit'){
		  lines.push(`üß© ${item.text}:`);
		  item.subtasks.forEach(subtask => {
			const icon = subtask.success ? '‚úÖ' : '‚ùå';
			let line = `   ${icon} ${subtask.name}`;
			if(subtask.quantity){
			  line += ` ‚Äî ${subtask.quantity} ${subtask.unit || ''}`;
			}
			const catalogHabit = findCatalogHabitByItem(subtask);
			if (catalogHabit) {
			  const key = String(catalogHabit.id);
			  if (streaksData && streaksData[key]) {
				line += `  üî•${streaksData[key].current}`;
			  }
			}
			const statsParts = [];
			['I','S','W','E','C','H'].forEach(k => {
			  if (subtask.stats && Number(subtask.stats[k]) !== 0) statsParts.push(`${k}[${Number(subtask.stats[k]).toFixed(2)}]`);
			});
			if (subtask.stats && (Number(subtask.stats.ST) || Number(subtask.stats.$))) {
			  if (Number(subtask.stats.ST) !== 0) statsParts.push(`ST[${Number(subtask.stats.ST)}]`);
			  if (Number(subtask.stats.$) !== 0) statsParts.push(`$[${Number(subtask.stats.$)}]`);
			}
			if (statsParts.length) line += ' ' + statsParts.join(' ');
			lines.push(line);
		  });
		}
	  });

    const stats = computeCompletionStats(parsed); // parsed ‚Äî –≤–∞—à –¥–µ–Ω—å/—Å–ø–∏—Å–æ–∫ –ø—Ä–∏–≤—ã—á–µ–∫
    lines.push('');
    lines.push(`–ü—Ä–∏–≤—ã—á–µ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: ${stats.completed} / ${stats.total} ( ${stats.percent}% )`);

	  if(dailyQuestions.length){
		lines.push('');
		lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
		lines.push('‚ûï –ö–û–ù–¢–†–û–õ–¨');
		lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
		dailyQuestions.forEach(q => {
		  lines.push(`‚Ä¢ ${q.q} ‚Üí ${q.a || '‚Äî'}`);
		});
	  }

	  if(thoughtsInput && thoughtsInput.value && thoughtsInput.value.trim()){
		lines.push('');
		lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
		lines.push('‚úçÔ∏è –ú–´–°–õ–ò');
		lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
		lines.push(thoughtsInput.value.trim());
	  }

	  return lines.join('\n');
	}

    
    function buildCSV(){
      const rows = [];
      const today = new Date();
      const todayISO = toISODate(today);
      const lastDayVal = Number(lastDayEl.value || 0);
      const dayNumber = lastDateEl.value ? lastDayVal + daysBetween(new Date(lastDateEl.value), today) : lastDayVal;
      
      rows.push(['–î–ï–ù–¨', '–î–∞—Ç–∞', 'STATE', '–¢–∏–ø', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', '–ï–¥–∏–Ω–∏—Ü–∞', '–£—Å–ø–µ—Ö', 'I', 'S', 'W', 'E', 'C', 'H', 'ST', '$', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è']);
      
      parsed.forEach(item => {
        if(item.type === 'habit' && !item.isSubtask){
          rows.push([
            dayNumber, todayISO, stateSelect ? stateSelect.value : 'WORK', '–ü—Ä–∏–≤—ã—á–∫–∞',
            item.name, item.quantity || '', item.unit || '',
            item.success ? '–î–∞' : '–ù–µ—Ç',
            item.stats.I, item.stats.S, item.stats.W, item.stats.E,
            item.stats.C, item.stats.H, item.stats.ST, item.stats.$,
            item.category || ''
          ]);
        }
        
        if(item.type === 'composite_habit'){
          rows.push([
            dayNumber, todayISO, stateSelect ? stateSelect.value : 'WORK', '–°–æ—Å—Ç–∞–≤–Ω–∞—è –ø—Ä–∏–≤—ã—á–∫–∞',
            item.text, '', '', '', '', '', '', '', '', '', '', '', item.category || ''
          ]);
          
          item.subtasks.forEach(subtask => {
            rows.push([
              dayNumber, todayISO, stateSelect ? stateSelect.value : 'WORK', '–ü–æ–¥–∑–∞–¥–∞—á–∞',
              subtask.name, subtask.quantity || '', subtask.unit || '',
              subtask.success ? '–î–∞' : '–ù–µ—Ç',
              subtask.stats.I, subtask.stats.S, subtask.stats.W, subtask.stats.E,
              subtask.stats.C, subtask.stats.H, subtask.stats.ST, subtask.stats.$,
              item.category || ''
            ]);
          });
        }
      });
      
      return rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
    }
    
    function updateReportOutput(){
      if (!reportOutput) return;
      reportOutput.textContent = buildReportText();
    }
    
    function saveStateToLocal(){
      if (!lastDayEl || !lastDateEl || !tasksInput || !stateSelect || !thoughtsInput) return;
      
      const payload = {
        lastDay: lastDayEl.value,
        lastDate: lastDateEl.value,
        inputText: tasksInput.value,
        parsed: parsed,
        state: stateSelect.value,
        thoughts: thoughtsInput.value,
        emotionMorning: emotionMorning,
        dailyQuestions: dailyQuestions
      };
      try{ 
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); 
      } catch(e){ 
        console.warn('save failed', e); 
      }
    }
    
    function loadStateFromLocal(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return false;
        const obj = JSON.parse(raw);
        
        if(lastDayEl && obj.lastDay) lastDayEl.value = obj.lastDay;
        if(lastDateEl && obj.lastDate) lastDateEl.value = obj.lastDate;
        if(tasksInput && obj.inputText) tasksInput.value = obj.inputText;
        if(obj.parsed) parsed = obj.parsed;
        if(stateSelect && obj.state) stateSelect.value = obj.state;
        if(thoughtsInput && obj.thoughts) thoughtsInput.value = obj.thoughts;
        if(obj.emotionMorning) emotionMorning = obj.emotionMorning;
        if(obj.dailyQuestions) dailyQuestions = obj.dailyQuestions;
        
        return true;
      } catch(e){ 
        console.warn('load failed', e); 
        return false; 
      }
    }
    
    function renderQuestions(){
      const box = document.getElementById('questionsBox');
      if (!box) return;
      
      box.innerHTML = '';
      dailyQuestions = CONTROL_QUESTIONS
        .sort(()=>Math.random()-0.5)
        .slice(0,3)
        .map(q=>({q, a:null}));

      dailyQuestions.forEach((item,i)=>{
        const d = document.createElement('div');
        d.className = 'state-desc';
        d.innerHTML = `
          ${item.q}<br>
          <select data-i="${i}">
            <option value="">‚Äî</option>
            <option>–î–∞</option>
            <option>–°–∫–æ—Ä–µ–µ –¥–∞</option>
            <option>–°–∫–æ—Ä–µ–µ –Ω–µ—Ç</option>
            <option>–ù–µ—Ç</option>
          </select>`;
        d.querySelector('select').onchange = e=>{
          dailyQuestions[i].a = e.target.value;
          updateReportOutput();
          saveStateToLocal();
        };
        box.appendChild(d);
      });
    }
    
    function renderEmotions(containerId, setter){
      const box = document.getElementById(containerId);
      if (!box) return;
      
      EMOTIONS.forEach(e=>{
        const b = document.createElement('button');
        b.textContent = e;
        b.className = 'emotion-btn';
        b.onclick = ()=>{
          setter(e);
          [...box.children].forEach(c=>c.classList.remove('active'));
          b.classList.add('active');
          updateReportOutput();
          saveStateToLocal();
        };
        box.appendChild(b);
      });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function init(){
      // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã DOM
      todayDisplay = document.getElementById('todayDisplay');
      currentDayDisplay = document.getElementById('currentDayDisplay');
      diffDaysEl = document.getElementById('diffDays');
      lastDayEl = document.getElementById('lastDay');
      lastDateEl = document.getElementById('lastDate');
      tasksInput = document.getElementById('tasksInput');
      parseBtn = document.getElementById('parseBtn');
      tasksList = document.getElementById('tasksList');
      makeReportBtn = document.getElementById('makeReport');
      reportOutput = document.getElementById('reportOutput');
      copyReport = document.getElementById('copyReport');
      downloadReport = document.getElementById('downloadReport');
      saveBtn = document.getElementById('saveBtn');
      loadBtn = document.getElementById('loadBtn');
      clearBtn = document.getElementById('clearBtn');
      resetStatusesBtn = document.getElementById('resetStatuses');
      sampleBtn = document.getElementById('sampleBtn');
      completedCountEl = document.getElementById('completedCount');
      totalCountEl = document.getElementById('totalCount');
      percentDoneEl = document.getElementById('percentDone');
      stateSelect = document.getElementById('stateSelect');
      stateDesc = document.getElementById('stateDesc');
      thoughtsInput = document.getElementById('thoughtsInput');
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
      if (todayDisplay) {
        const today = new Date();
        todayDisplay.textContent = toISODate(today);
      }
      if (lastDateEl && !lastDateEl.value) {
        lastDateEl.value = toISODate(new Date());
      }
      
      renderMeta();
      
      if(loadStateFromLocal()){
        renderTasks(); 
        updateReportOutput(); 
      }
      
      renderEmotions('emotionMorning', v => emotionMorning = v);
      renderQuestions();
      
      // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
      loadHabitsCatalog();
      loadDatesFromDB();
	  loadAllTimeTotals();
    loadCombinations();
	  loadStreaks();
      loadPeriodStats('week');
      
      // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      setupEventListeners();
    }
    
    function setupEventListeners() {
      document.getElementById('manageCombosBtn')?.addEventListener('click', openCombos);
      
      if (parseBtn) {
        parseBtn.addEventListener('click', () => {
          parsed = parseTextToStructure(tasksInput.value);
          renderMeta();
          renderTasks();
          updateReportOutput();
          saveStateToLocal();
        });
      }
      
      if (makeReportBtn) {
        makeReportBtn.addEventListener('click', () => { 
          updateReportOutput(); 
        });
      }
      
      if (copyReport) {
        copyReport.addEventListener('click', () => { 
          const text = reportOutput ? reportOutput.textContent : buildReportText();
          navigator.clipboard?.writeText(text).then(() => {
            alert('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä');
          }).catch(() => {
            prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é:', text);
          });
        });
      }
      
      if (downloadReport) {
        downloadReport.addEventListener('click', () => { 
          const txt = reportOutput ? reportOutput.textContent : buildReportText();
          const blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `report_${toISODate(new Date())}.txt`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        });
      }
      
      if (saveBtn) {
        saveBtn.addEventListener('click', () => { 
          saveStateToLocal(); 
          alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ localStorage.'); 
        });
      }
      
      if (loadBtn) {
        loadBtn.addEventListener('click', () => { 
          if(loadStateFromLocal()){ 
            renderMeta(); 
            renderTasks(); 
            updateReportOutput(); 
            alert('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ localStorage.'); 
          } else { 
            alert('–î–∞–Ω–Ω—ã—Ö –≤ localStorage –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.'); 
          }
        });
      }
      
      if (clearBtn) {
        clearBtn.addEventListener('click', () => { 
          if(confirm('–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É –∏ localStorage?')){ 
            localStorage.removeItem(STORAGE_KEY); 
            if (tasksInput) tasksInput.value = ''; 
            parsed = []; 
            if (thoughtsInput) thoughtsInput.value = ''; 
            if (stateSelect) stateSelect.value = 'WORK'; 
            emotionMorning = null;
            renderMeta(); 
            renderTasks(); 
            updateReportOutput(); 
          } 
        });
      }
      
      if (resetStatusesBtn) {
        resetStatusesBtn.addEventListener('click', () => { 
          parsed.forEach(item => {
            if(item.type === 'habit') item.success = false;
            if(item.type === 'composite_habit'){
              item.subtasks.forEach(st => st.success = false);
            }
          }); 
          renderTasks(); 
          renderMeta();
          updateReportOutput(); 
          saveStateToLocal(); 
        });
      }
      
      if (sampleBtn) {
        sampleBtn.addEventListener('click', () => { 
          const sampleText = `–ó–¥–æ—Ä–æ–≤—å–µ
‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
* –§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞:
    + –ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è ‚Äî 75 —Ä–∞–∑ I[0.00] S[0.01] W[0.01] E[0.00] C[0.01] H[0.01] ST[1] $[0]
    + –û—Ç–∂–∏–º–∞–Ω–∏—è ‚Äî 30 —Ä–∞–∑ I[0.00] S[0.01] W[0.01] E[0.00] C[0.01] H[0.01] ST[1] $[0]
    + –ü–ª–∞–Ω–∫–∞ ‚Äî 60 —Å–µ–∫—É–Ω–¥ I[0.00] S[0.00] W[0.02] E[0.00] C[0.00] H[0.01] ST[1] $[0]
    
+ –ü–∏—Ç—å –≤–æ–¥—É ‚Äî 2 –ª–∏—Ç—Ä–∞ I[0.00] S[0.00] W[0.01] E[0.00] C[0.01] H[0.02] ST[1] $[0]
+ –í–∏—Ç–∞–º–∏–Ω—ã I[0.01] S[0.00] W[0.00] E[0.00] C[0.00] H[0.01] ST[1] $[-5]

–†–∞–∑–≤–∏—Ç–∏–µ
‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
+ –ß—Ç–µ–Ω–∏–µ ‚Äî 30 —Å—Ç—Ä–∞–Ω–∏—Ü I[0.02] S[0.00] W[0.00] E[0.01] C[0.01] H[0.00] ST[1] $[0]
+ –ò–∑—É—á–µ–Ω–∏–µ —è–∑—ã–∫–∞ ‚Äî 25 –º–∏–Ω—É—Ç I[0.03] S[0.00] W[0.00] E[0.00] C[0.01] H[0.00] ST[1] $[0]

–†–∞–±–æ—Ç–∞
‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
+ –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç ‚Äî 4 —á–∞—Å–∞ I[0.05] S[0.00] W[0.01] E[0.00] C[0.02] H[0.00] ST[2] $[50]
+ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–Ω—è I[0.01] S[0.00] W[0.00] E[0.01] C[0.00] H[0.00] ST[1] $[0]`;
          
          if (tasksInput) tasksInput.value = sampleText;
          if (thoughtsInput) thoughtsInput.value = '–•–æ—Ä–æ—à–∏–π –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–π –¥–µ–Ω—å. –£–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏. –ó–∞–≤—Ç—Ä–∞ —É–¥–µ–ª–∏—Ç—å –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç–µ –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ç–æ–º.';
          
          parsed = parseTextToStructure(sampleText);
          renderMeta(); 
          renderTasks(); 
          updateReportOutput(); 
          saveStateToLocal();
        });
      }
      
      if (stateSelect) {
        stateSelect.addEventListener('change', () => { 
          renderMeta(); 
          saveStateToLocal(); 
        });
      }
      
      if (thoughtsInput) {
        thoughtsInput.addEventListener('input', () => { 
          saveStateToLocal(); 
        });
      }
      
      const downloadCSVBtn = document.getElementById('downloadCSV');
      if (downloadCSVBtn) {
        downloadCSVBtn.addEventListener('click', () => {
          const csv = buildCSV();
          const csvWithBOM = '\uFEFF' + csv;
          const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `report_${toISODate(new Date())}.csv`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        });
      }
      
      const downloadPlainTXTBtn = document.getElementById('downloadPlainTXT');
      if (downloadPlainTXTBtn) {
        downloadPlainTXTBtn.addEventListener('click', () => {
          const todayISO = toISODate(new Date());
          const lines = [];
          
          const lastDayVal = Number(lastDayEl ? lastDayEl.value : 0);
          const dayNumber = lastDateEl && lastDateEl.value ? lastDayVal + daysBetween(new Date(lastDateEl.value), new Date()) : lastDayVal;
          
          lines.push(`DAY|${todayISO}|${dayNumber}|${stateSelect ? stateSelect.value : 'WORK'}`);
          
          const totals = calculateTotalStats(parsed);
          lines.push(`STATS_TOTAL|I:${totals.I}|S:${totals.S}|W:${totals.W}|E:${totals.E}|C:${totals.C}|H:${totals.H}|ST:${totals.ST}|$:${totals.$}`);
          
          parsed.forEach(item => {
            if(item.type === 'category'){
              lines.push(`CATEGORY|${item.text}`);
            } else if(item.type === 'habit' && !item.isSubtask){
              const status = item.success ? 'DONE' : 'TODO';
              const stats = `I${item.stats.I}S${item.stats.S}W${item.stats.W}E${item.stats.E}C${item.stats.C}H${item.stats.H}ST${item.stats.ST}$${item.stats.$}`;
              lines.push(`HABIT|${status}|${item.name}|${item.quantity || ''}|${item.unit || ''}|${stats}`);
            } else if(item.type === 'composite_habit'){
              lines.push(`COMPOSITE|${item.text}`);
              item.subtasks.forEach(st => {
                const status = st.success ? 'DONE' : 'TODO';
                const stats = `I${st.stats.I}S${st.stats.S}W${st.stats.W}E${st.stats.E}C${st.stats.C}H${st.stats.H}ST${st.stats.ST}$${st.stats.$}`;
                lines.push(`SUBTASK|${status}|${st.name}|${st.quantity || ''}|${st.unit || ''}|${stats}`);
              });
            }
          });
          
          lines.push(`EMOTION|Morning|${emotionMorning || '-'}`);
          
          dailyQuestions.forEach(q => {
            lines.push(`QUESTION|${q.q}|${q.a || '-'}`);
          });
          
          if(thoughtsInput && thoughtsInput.value && thoughtsInput.value.trim()){
            lines.push(`THOUGHT|${thoughtsInput.value.trim().replace(/\n/g, ' ')}`);
          }
          
          const txt = lines.join('\n');
          const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `${todayISO}.txt`;
          document.body.appendChild(a);
          a.click();
          a.remove();
        });
      }
      
      if (lastDateEl) {
        lastDateEl.addEventListener('change', () => { 
          renderMeta(); 
          saveStateToLocal(); 
        });
      }
      
      if (lastDayEl) {
        lastDayEl.addEventListener('change', () => { 
          renderMeta(); 
          saveStateToLocal(); 
        });
      }
      
      const loadFromDBBtn = document.getElementById('loadFromDBBtn');
      if (loadFromDBBtn) {
        loadFromDBBtn.addEventListener('click', () => {
          const dbDateSelect = document.getElementById('dbDateSelect');
          if (dbDateSelect) {
            dbDateSelect.value = toISODate(new Date());
            loadDayFromDB();
          }
        });
      }
      
      const saveToDBBtn = document.getElementById('saveToDBBtn');
      if (saveToDBBtn) {
        saveToDBBtn.addEventListener('click', saveDayToDB);
      }
      
      const addFromCatalogBtn = document.getElementById('addFromCatalogBtn');
      if (addFromCatalogBtn) {
        addFromCatalogBtn.addEventListener('click', () => {
          showModal('habitCatalogModal');
        });
      }
    }
    
    // –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>